<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.js'></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
</head>
<body>
    <script>
        let nextSyncToken;
        let nextPageToken;
        let calendar;
        let events=[];
        let access_token;
        let event_color = ['red','blue','green','gray','orange','skyblue'];
        
        const YOUR_CLIENT_ID = '844201455335-l3aj61jt5renkdt1vk4tf0gq96bgh9h8.apps.googleusercontent.com'; //클라이언트 아이디
        const YOUR_REDIRECT_URI = 'http://localhost:5500/javascript/calendarGoogle.html'; //리다이렉트 url oauth 클라이언트에서 설정한 것과 같아야함
        
        getUserCalendarList(); //캘린더 ID 수집
        
        $(document).ready(function() {
           let calendarEl = document.getElementById('calendar');
           let calendarList = [];
           calendar = new FullCalendar.Calendar(calendarEl, {
              initialView: 'dayGridMonth',
              //themeSystem: 'bootstrap', //부트스트랩 테마
              height: 850,
              timeZone: 'local',
              locale: 'ko',
              fixedWeekCount:false,
              displayEventTime: false,
              headerToolbar :{
                 start:'',
                 center:'prev,title,next',
                 end:'syncBtn'
              },
              eventTimeFormat: {
                 hour: '2-digit',
                 minute: '2-digit',
                 hour12: false,
                 meridiem: false
              }, 
              events : [],
           });
           calendar.render();
           
           
           
        });
        
        
        
        // Parse query string to see if page request is coming from OAuth 2.0 server.
        /* let fragmentString = location.hash.substring(1);
        let params = {};
        let regex = /([^&=]+)=([^&]*)/g, m;
        while (m = regex.exec(fragmentString)) {
           params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
        }
        
        if (Object.keys(params).length > 0) {
           localStorage.setItem('oauth2-test-params', JSON.stringify(params) );
           if (params['state'] && params['state'] == 'try_sample_request') {
              trySampleRequest();
           }
        } */
        
        // If there's an access token, try an API request.
        // Otherwise, start OAuth 2.0 flow.
        function trySampleRequest(calendarId,color) {
           var xhr = new XMLHttpRequest();
           xhr.open('GET',
              'https://www.googleapis.com/calendar/v3/calendars/'+calendarId+'/events?' +
              'access_token=' + access_token);
              //xhr.responseType='json';
           xhr.onreadystatechange = function (e) {
              if (xhr.readyState === 4 && xhr.status === 200) { // 성공시
                 //console.log(JSON.parse(xhr.response));
                 let result = JSON.parse(xhr.response);
                 
                 result.items.forEach(item=>{
                    calendar.addEvent({
                        id     : item.id,
                       title : item.summary,
                       start : item.start.date,
                       end : item.end.date,
                       color:color
                     });
                 })
                 //nextPageToken = result.nextPageToken;
                 //nextSyncToken = result.nextSyncToken;
                 console.log(events);
              }
           }
           xhr.send(null);
           /*
           let params = JSON.parse(localStorage.getItem('oauth2-test-params'));
           //console.log(params) //토큰 확인
           if (params && params['access_token']) {
              var xhr = new XMLHttpRequest();
              xhr.open('GET',
                 'https://www.googleapis.com/calendar/v3/calendars/'+calendarId+'/events?' +
                 'access_token=' + params['access_token']);
                 //xhr.responseType='json';
              xhr.onreadystatechange = function (e) {
                 if (xhr.readyState === 4 && xhr.status === 200) { // 성공시
                 //console.log(JSON.parse(xhr.response));
                 let result = JSON.parse(xhr.response);
                 
                 result.items.forEach(item=>{
                    events.push({
                         id     : item.id,
                       title : item.summary,
                       start : item.start.date,
                       end : item.end.date
                      });
                 })
                 
                 nextPageToken = result.nextPageToken;
                 nextSyncToken = result.nextSyncToken;
              } else if (xhr.readyState === 4 && xhr.status === 401) { // Token invalid, so prompt for user permission.
                 oauth2SignIn();
              }
           };
           xhr.send(null);
           } else {
              oauth2SignIn();
           }
           */
        }
        
        //Create form to request access token from Google's OAuth 2.0 server.
        function oauth2SignIn() {
           // Google's OAuth 2.0 endpoint for requesting an access token
           let oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';
        
           // Create element to open OAuth 2.0 endpoint in new window.
           let form = document.createElement('form');
           form.setAttribute('method', 'GET'); // Send as a GET request.
           form.setAttribute('action', oauth2Endpoint);
        
           // Parameters to pass to OAuth 2.0 endpoint. 'redirect_uri': 'http://localhost:8081/login/oauth2/code/google',
           let params = {'client_id': '844201455335-l3aj61jt5renkdt1vk4tf0gq96bgh9h8.apps.googleusercontent.com',
                        'redirect_uri': 'http://localhost:5500/javascript/calendarGoogle.html',
                        'scope': 'https://www.googleapis.com/auth/drive.metadata.readonly',
                        'state': 'try_sample_request',
                        'include_granted_scopes': 'true',
                        'response_type': 'token'};
        
           // Add form parameters as hidden input values.
           for (var p in params) {
              var input = document.createElement('input');
              input.setAttribute('type', 'hidden');
              input.setAttribute('name', p);
              input.setAttribute('value', params[p]);
              form.appendChild(input);
           }
        
           // Add form to page and submit it to open the OAuth 2.0 endpoint.
           document.body.appendChild(form);
           form.submit();
        }
        
        //소유한 구글 캘린더 id 수집 fn
        function getUserCalendarList() {
           let params = JSON.parse(localStorage.getItem('oauth2-test-params')); //로컬 스토리지에 access_token이 확인
           access_token = params['access_token'];
           //console.log(params) //토큰 확인
           
           if (params && params['access_token']) { //로컬 스토리지에 access_token이 확인
              var xhr = new XMLHttpRequest();
              xhr.open('GET',
                 'https://www.googleapis.com/calendar/v3/users/me/calendarList?' +
                 'access_token=' + params['access_token']);
           
              xhr.onreadystatechange = function (e) {
                 if (xhr.readyState === 4 && xhr.status === 200) { // 성공시
                 let result = JSON.parse(xhr.response);
                 let cnt = 0;
                 result.items.forEach(item => {
                    trySampleRequest(item.id,event_color[cnt++]);
                 })
                 
                 } else if (xhr.readyState === 4 && xhr.status === 401) { // Token invalid, so prompt for user permission.
                    oauth2SignIn();
                 }
              };
              xhr.send(null);
           } else {
              oauth2SignIn();
           }
        }
        </script>
        
        
        <style>
           .fc-daygrid-event{
              height:25px !important;
              margin-top:1px !important;
              margin-bottom:1px !important;
           }
           
           .fc-view-harness-active > .fc-view{
              margin-top:0px !important;
           }
           
           .fc-prev-button{
              float:left !important;
              margin-right:5px !important;
              height:30px !important;
           }
           
           .fc-next-button{
              float:left !important;
              margin-left:5px !important;
              height:30px !important;
           }
           
           .fc-prev-button span,.fc-next-button span{
              line-height: 15px;
           }
           
           .fc-toolbar-title{
              float:left !important;
           }
           
           .fc-header-toolbar{
              margin-top:5px !important;
              margin-bottom:5px !important;
           }
           
           .calendar_control_panel{
              width:100%;
              height:20px;
           }
        </style>
        <div class="content-wrap">
            <div class="main">
                <div class="container-fluid">
                 <div class="row">
                       <div class="col-lg-12">
                           <div id="calendar"></div>
                       </div>
                 </div>
                </div>
            </div>
        </div>
</body>
</html>